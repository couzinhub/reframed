<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reframed</title>
  <meta name="description" content="A collection of paintings reframed to fit the Samsung Frame TV perfectly.">
  <link rel="icon" href="img/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css.css">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-14360H9J7X"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-14360H9J7X');
  </script>
</head>
<body>

  <div class="container">

    <h1 class="logo-title">
      <img src="img/reframed.svg" alt="Reframed Logo">
    </h1>
    <p>A collection of paintings modified to fit the Samsung Frame TV perfectly.</p>
    <p>Click on any image to download the full version.</p>
    <div class="btn-container">
      <script src="https://storage.ko-fi.com/cdn/widget/Widget_2.js"></script>
      <script>
        kofiwidget2.init('Thank me with a tip', '#00488c', 'O5O51FWPUL');
        kofiwidget2.draw();
      </script>
      <a class="contact" href="/contact.html">Get your own art reframed</a>  
    </div>
      


    <main id="homeView"></main>

    <footer id="footer">
      <p id="last-updated"></p>
    </footer>
    
  </div>

  <script>
    // === CONFIG ===
    const CLOUD_NAME = "dqqutqsna"; // <-- your cloud name

    // This is the public CSV URL from "Publish to web" in Google Sheets.
    // Example format:
    // https://docs.google.com/spreadsheets/d/XXXXX/pub?output=csv
    const TAGS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRwK--cdffX8xQhDBsXICgnnEQLJKjInyEzj8IXJYTkD65Cb-rWYqyL53lUV5ca9zm70qF95O_wb9KV/pub?output=csv";

    const THUMB_TRANSFORM = "c_fill,w_700,q_auto,f_auto";

    // === HELPERS ===
    function buildThumbUrl(publicId) {
      // encodeURI keeps folder slashes intact
      return `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/${THUMB_TRANSFORM}/${encodeURI(publicId)}`;
    }

    function buildFullUrl(publicId) {
      return `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/f_auto,q_auto/${encodeURI(publicId)}`;
    }

    // === DATA LOADING ===

    // 1. Get the list of tags in order from the CSV
    async function loadTagsFromSheet() {
      // Bust cache so we always get the latest sheet
      const url = TAGS_CSV_URL + (TAGS_CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now();

      const res = await fetch(url, { cache: "no-cache" });
      if (!res.ok) {
        throw new Error("Could not load tag list (HTTP " + res.status + ")");
      }

      const csvText = await res.text();

      const rows = csvText.split(/\r?\n/);

      const tags = [];
      for (let rawRow of rows) {
        if (!rawRow.trim()) continue; // skip empty lines

        // Take ONLY the first column of the row.
        // This handles rows like: Classics,Some note,...
        // and turns it into "Classics"
        let firstCell = rawRow.split(",")[0];

        // Remove wrapping quotes if Google added them
        firstCell = firstCell.replace(/^"(.*)"$/, "$1").trim();

        if (!firstCell) continue;
        if (firstCell.startsWith("#")) continue;

        // Stop processing completely at the first `-- ignore`
        if (firstCell.toLowerCase().startsWith("-- ignore")) {
          break;
        }

        tags.push(firstCell);
      }

      // Debug helper (you can leave this in for now to verify order in DevTools)
      console.log("Resolved tags from sheet:", tags);

      return tags;
    }

    // 2. Fetch Cloudinary resources for a single tag
    async function fetchImagesForTag(tagName) {
      const url = `https://res.cloudinary.com/${encodeURIComponent(CLOUD_NAME)}/image/list/${encodeURIComponent(tagName)}.json`;
      const res = await fetch(url, { mode: "cors" });
      if (!res.ok) {
        throw new Error(`Tag "${tagName}" request failed (HTTP ${res.status})`);
      }
      const data = await res.json();

      // Newest first
      const items = (data.resources || []).sort(
        (a,b) => (b.created_at || "").localeCompare(a.created_at || "")
      );
      return items;
    }

    // === DOM BUILDING ===
function createCard(r) {
  const publicId = r.public_id;

  // Get the last part after any folders
  let fileName = publicId.split("/").pop();

  // Convert underscores to spaces
  // Remove the " - reframed whatever" suffix
  // Collapse double spaces, trim
  let cleanTitle = fileName
    .replace(/_/g, " ") // underscores â†’ spaces
    // remove things like " - reframed_xyz123" or " - reframed xyz123"
    .replace(/\s*-\s*reframed[\s_-]*[a-z0-9]+$/i, "")
    .replace(/\s{2,}/g, " ")
    .trim();

  const title = cleanTitle;

  const card = document.createElement("div");
  card.className = "card";

  const link = document.createElement("a");
  link.href = buildFullUrl(publicId);
  link.target = "_blank";
  link.rel = "noopener";

  const img = document.createElement("img");
  img.loading = "lazy";
  img.src = buildThumbUrl(publicId);
  img.alt = title;
  link.appendChild(img);

  const meta = document.createElement("div");
  meta.className = "info-overlay";
  meta.innerHTML = `<h3>${title}</h3>`;

  card.appendChild(link);
  card.appendChild(meta);

  return card;
}

    function renderTagSection(tagName, items, errorMsg = null) {
      const section = document.createElement("section");
      section.className = "gallery-block";

      const h2 = document.createElement("h2");
      h2.textContent = tagName;

      const countSpan = document.createElement("div");
      countSpan.className = "block-count";

      if (errorMsg) {
        countSpan.textContent = "";
      } else {
        countSpan.textContent = `${items.length} image${items.length === 1 ? "" : "s"}`;
      }

      const statusP = document.createElement("div");
      statusP.className = "block-status";

      if (errorMsg) {
        statusP.innerHTML = `<span class="error-msg">${errorMsg}</span>`;
      } else if (items.length === 0) {
        statusP.textContent = "No images for this tag.";
      } else {
        statusP.textContent = "";
      }

      const grid = document.createElement("div");
      grid.className = "gallery";

      if (!errorMsg) {
        for (const r of items) {
          grid.appendChild(createCard(r));
        }
      }

      section.appendChild(h2);
      section.appendChild(countSpan);
      section.appendChild(grid);
      return section;
    }

    async function buildHomeView() {
      const homeView = document.getElementById("homeView");
      homeView.innerHTML = "";

      let tags;
      try {
        tags = await loadTagsFromSheet();
      } catch (err) {
        const fail = document.createElement("div");
        fail.className = "error-msg";
        fail.textContent = "Couldn't load tag list: " + err.message;
        homeView.appendChild(fail);
        return;
      }

      // IMPORTANT:
      // We loop tags in order, and we await each fetch in order,
      // so rendering will follow exactly your sheet's order.
      for (const tagName of tags) {
        try {
          const items = await fetchImagesForTag(tagName);
          const sectionEl = renderTagSection(tagName, items, null);
          homeView.appendChild(sectionEl);
        } catch (err) {
          const sectionEl = renderTagSection(tagName, [], err.message);
          homeView.appendChild(sectionEl);
        }
      }
    }


    // boot
    buildHomeView();
  </script>
</body>
</html>
